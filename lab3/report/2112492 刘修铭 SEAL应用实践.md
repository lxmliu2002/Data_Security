# <center>数据安全实验报告</center>

<center>Lab3 SEAL 应用实践</center>

<center> 网络空间安全学院 信息安全专业</center>

<center> 2112492 刘修铭 1036</center>

## 实验要求

参考教材实验 2.3，实现将三个数的密文发送到服务器完成 $x^3+ y \times z$ 的运算。




## 实验原理

### 开发框架 SEAL

SEAL(Simple Encrypted Arithmetic Library) 是微软开源的基于 C++ 的同态加密库，支持 CKKS 方案等多种全同态加密方案，支持基于整数的精确同态运算和基于浮点数的近似同态运算。该项目采用商业友好的 MIT 许可证在 GitHub 上（[https://github.com/microsoft/SEAL](https://github.com/microsoft/SEAL)）开源。

SEAL 基于 C++ 实现，不需要其他依赖库。 

### CKKS 算法

CKKS 是 2017 年提出的同态加密方案。它支持浮点向量在密文空间的加减乘运算并保持同态，但是只支持有限次乘法的运算。

如图是 CKKS 的一个大概流程。先对消息（向量）进行编码，然后再加密，在密文空间进行一些运算后再解密，最后解码成运算后的消息（向量）。

> 注意，这里的编码指的是将复数向量映射成为多项式，是为了方便下面进一步的加密， 

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319084046347.png" alt="image-20240319084046347" style="zoom:33%;" />

如图，这是 CKKS 编、解码的过程。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319084132239.png" alt="image-20240319084132239" style="zoom: 33%;" />



## 实验过程（含主要源代码）

### 实验环境配置

运行命令 `git clone https://github.com/microsoft/SEAL `，克隆加密库资源。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319082652759.png" alt="image-20240319082652759" style="zoom:50%;" />

接着运行 `cmake`，进行编译环境的配置。

> 此处本人一次成功，但舍友一直失败，经过探索，确定是由于网络问题导致，需要科学上网。而虚拟机对于网络的配置较为玄学，WSL 的优势得以显现。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319082748094.png" alt="image-20240319082748094" style="zoom:50%;" />

运行 `make` 进行编译

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319083013014.png" alt="image-20240319083013014" style="zoom:50%;" />

最后，`sudo make install`，复制相关文件到指定文件夹中

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319083103389.png" alt="image-20240319083103389" style="zoom:50%;" />

按照实验手册说明，创建 `demo` 文件夹，并写入 `test.cpp` 和 `CMakeLists.txt` 文件，以进行安装测试。编写完成后，在控制台依次运行 `cmake .`、 `make` 和 `./test` 进行测试。

### CKKS 应用示例

按照实验手册说明，将对应的代码复制到对应的文件夹中。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319084620226.png" alt="image-20240319084620226" style="zoom:50%;" />

将 `example.h` 复制到对应文件夹，并修改 `CMakeLists.txt` 文件。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319084747820.png" alt="image-20240319084747820" style="zoom:50%;" />

接着打开控制台，依次运行 `cmake .`、 `make` 和 `./he`，对项目进行编译并运行。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319084722302.png" alt="image-20240319084722302" style="zoom: 50%;" />

### CKKS 改写






## 实验结果及分析

### 实验环境配置

在测试程序中，得到如下结果。可以看到，成功输出 hwllow world，说明环境配置成功。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319083320003.png" alt="image-20240319083320003" style="zoom:50%;" />

### CKKS 应用示例

CKKS 应用示例部分，编译并运行后，得到如下结果。

<img src="./2112492%20%E5%88%98%E4%BF%AE%E9%93%AD%20SEAL%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5.pic/image-20240319084834383.png" alt="image-20240319084834383" style="zoom: 50%;" />

可以确认，$6=1\times2\times3$，$24=2\times3\times4$，$60=3\times4\times5$，说明程序逻辑正确，运行成功。

### CKKS 改写

完成代码的编写后，修改 `CMakeLists.txt` 文件。

```cmake
cmake_minimum_required(VERSION 3.10)
project(demo)
add_executable(he homework.cpp)
add_compile_options(-std=c++17)
find_package(SEAL)
target_link_libraries(he SEAL::seal)
```

然后运行 `cmake .` 和 `make`，对程序进行编译。

<img src="./2112492 刘修铭 SEAL应用实践.pic/9b9449972118116da68368cb24acbde.png" alt="9b9449972118116da68368cb24acbde" style="zoom:50%;" />

接着输入 `./he` 运行程序。

<img src="./2112492 刘修铭 SEAL应用实践.pic/8f69100f38a6f4bb58258e7dbfcef44.png" alt="8f69100f38a6f4bb58258e7dbfcef44" style="zoom:50%;" />

可以确认，$7=1\times1+2\times3$，$20=2\times2+3\times4$，$47=3\times3+4\times5$，说明程序逻辑正确，运行成功。



## 文件组织说明

本次实验中用到的所有代码均已置于 `./codes` 文件中。

* `./codes/seal_demo` 为测试 SEAL 的 demo 程序
* `./codes/test` 为 CKKS 应用示例程序
* `./codes/homework` 为改写的 CKKS 应用程序
* `./2112492 刘修铭 SEAL应用实践.pdf` 为本次实验的实验报告

```shell
.
├──codes
│  ├── homework
│  │   ├── CMakeLists.txt
│  │   ├── Makefile
│  │   ├── examples.h
│  │   ├── he
│  │   └── homework.cpp
│  ├── seal_demo
│  │   ├── CMakeLists.txt
│  │   ├── Makefile
│  │   ├── test
│  │   └── test.cpp
│  └── test
│      ├── CMakeLists.txt
│      ├── Makefile
│      ├── ckks_example.cpp
│      ├── examples.h
│      └── he
└── 2112492 刘修铭 SEAL应用实践.pdf
```



## 参考

本次实验主要参考教材内容完成。